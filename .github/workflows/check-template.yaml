name: flake template check

on:
  push:
    branches: [master]
  # To be able to trigger a rebuild manually by (un)assigning someone
  # https://docs.github.com/en/actions/reference/workflows-and-actions/events-that-trigger-workflows#pull_request
  pull_request:
    types: [opened, reopened, synchronize, assigned, unassigned]

jobs:
  template-check:
    name: init default template and check it
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Install magic nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Show Nix version
        run: nix --version

      - name: Build host VMs for template nixosConfigurations
        run: |
          FLAKE_DIR=$(pwd)

          DIR=$(mktemp -d)
          cd $DIR

          nix flake init --template path:$FLAKE_DIR/#basic

          # echo use the local flake, otherwise we'll test against the master-branch flake in PRs
          head flake.nix
          sed -i -e 's@github:0xB10C/peer-observer-infra-library@path://"$FLAKE_DIR"@g' flake.nix
          head flake.nix

          git init
          git add .

          hosts=($(nix flake show --json | jq -r '.nixosConfigurations | keys[]'))
          for host in "${hosts[@]}"
          do
            nix develop --command bash -c "build-vm $host"
          done
      - run: df -h
